System Configuration
==================

## Configuration Files
The majority of configuration settings are stored in the following files:
  * dc_config/cybercom_config.env
    * Used for general application settings and container versions
    * Configure Nginx to use Let's Encrypt
    * Configure MongoDB database name and Docker volume prefix
    * Set the `ALLOWED_HOSTS` setting - this must be updated if running on a publicly accessible server!
  * dc_config/secrets.env (This should be copied from dc_config/secrets_template.env as a starting point)
    * !!! Once created, you should change the default credentials as they are not secure !!!
    * Used to store sensitive variables that should not be tracked in version control
    * Set MongoDB and RabbitMQ credentials
    * Configure email server connection
    * SSL configration
    * Configure Let's Encrypt reminder notification email address `NOTIFY_EMAIL`
  * requirements.txt
    * Python requirements for the API / Django 
  * dc_config/images/celery/requirements.txt
    * Python requirements for the dockerized Celery container

It is recommended to copy dc_config/secrets_template.env to dc_config/secrets.env as a starting point. Once created, you should change the default credentials as they are not secure!
Running any `make` commands without dc_config/secrets.env in place will attempt to copy the template file and open it in your default text editor or nano. If this fails, running any `make` command will stop with a reminder to manually copy dc_config/secrets_template.env to dc_config/secrets.env.

## Generating SSL Keys and Where They Are Stored
Rabbitmq and MongoDB are configured to use SSL certificates to secure their communications. By default, during the setup of cyberCommons, these certificates are configured to be valid for 365 days. This default can be changed by editing the `CA_EXPIRE` value in the dc_config/secrets.env file. Once the certificates expire, they will need to be regenerated by running `make initssl`.
### Generating SSL Certificates
  Self-signed certificates are automatically generated on first run for RabbitMQ and MongoDB. Generation of self-signed certificates for NGINX is currently not implemented.
  Let's Encrypt - refer to the [Let's Encrypt](installation.html#build-let-s-encrypt-docker-container) section of the installation instructions.

### Renewing SSL Certificates
  1. Self-signed certificates can be updated by running the following command from the cyberCommons root directory:

  	$ make initssl

  *All remote Celery workers will need the new SSL client certificates to resume communications. See the section below on where these certificates are stored*

  1. Let's Encrypt certificates can be renewed by running the following command from the cyberCommons root directory and follow Let's Encrypt prompts:
  
    $ make renew_certbot

### SSL Certificate Locations
  1. Self-signed locations:
     * MongoDB
       - dc_config/ssl/backend/client/mongodb.pem
       - dc_config/ssl/backend/server/mongodb.pem
       - dc_config/ssl/testca/cacert.pem
     * RabbitMQ
       - dc_config/ssl/backend/client/key.pem
       - dc_config/ssl/backend/client/cert.pem
       - dc_config/ssl/backend/server/key.pem
       - dc_config/ssl/backend/server/cert.pem
       - dc_config/ssl/testca/cacert.pem

  1. Let's Encrypt location:
     * NGINX
       - dc_config/ssl/nginx/letcencrypt/etc/live/*

## Configure Email Backend
* Populate the Email Configuration section in dc_config/secrets.env. *The following is an example of using gmail.*
~~~
EMAIL_BACKEND=django.core.mail.backends.smtp.EmailBackend
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_HOST_USER=username@gmail.com
EMAIL_HOST_PASSWORD=password
EMAIL_USE_TLS=True
~~~

## Turn On Debug Mode for RESTful API
The Debug mode is turned off by default. If you need debug messages
* Set `DEBUG=True` in dc_config/cybercom_config.py
* Add host(s) to `ALLOWED_HOSTS` list if needed. See Django's documentation on the [ALLOWED_HOSTS](https://docs.djangoproject.com/en/3.2/ref/settings/#allowed-hosts) setting for more details.

## Configure External MongoDB or AWS DocumentDB
* Set `USE_LOCAL_MONGO=False` in dc_config/cybercom_config.py.
*The following is an example of configuring external mongodb in dc_config/secrets.env*
~~~
MONGO_HOST=externaldb.example.org
MONGO_PORT=27017
MONGO_CERT_KEY_FILE=/ssl/client/mongodb.pem
MONGO_CA_FILE=/ssl/testca/cacert.pem
~~~
* If you need to override the default Mongo URI configuaration, update `MONGO_URI_OVERRIDE` in dc_config/secrets.env file. This can be used to point to AWS DocumentDB or other external MongoDB with specific paramters. 
~~~
#Override MongoDB connection with custom URI, for example MONGO_URI_OVERRIDE=mongo://user:pass@host:port/?arg1=true&arg2=true
MONGO_URI_OVERRIDE=mongo://user:pass@externaldb.example.org:27017/?ssl=true&ssl_ca_certs=/ssl/cacert.pem
~~~
* If using an external CA certificate or keyfile 
  1. Copy certificate to dc_config/ssl/backend/ 
  1. Update `MONGO_CERT_KEY_FILE` and `MONGO_CA_FILE` in dc_config/secrets.env using the prefix /ssl. For example 
    `
    MONGO_CA_FILE=/ssl/cacert.pem
    `